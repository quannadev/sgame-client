{"version":3,"sources":["assets/_smartfox/gui/TwoScrollView.js"],"names":["self","cc","Class","ViewGroup","properties","scrollView","ScrollView","parentListView","cancelInnerEvents","animatable","onLoad","direction","start_loc","node","on","Node","EventType","TOUCH_START","_onTouchBegan","TOUCH_MOVE","_onTouchMoved","TOUCH_END","_onTouchEnded","TOUCH_CANCEL","_onTouchCancelled","stopAutoScroll","update","getContentPosition","y","vertical","_hasNestedViewGroup","event","captureListeners","eventPhase","Event","CAPTURING_PHASE","i","length","item","target","getComponent","_stopPropagationIfTargetIsMe","AT_TARGET","stopPropagation","enabledInHierarchy","touch","getLocation","_handlePressLogic","_touchMoved","now_pos","delta_x","Math","abs","x","delta_y","_handleMoveLogic","deltaMove","sub","getStartLocation","mag","cancelEvent","EventTouch","getTouches","bubbles","type","simulate","dispatchEvent","_handleReleaseLogic","_dispatchEvent","_clampDelta","delta","getDelta","_processDeltaMove","_gatherTouchMove","_processInertiaScroll"],"mappings":"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","sourceRoot":"/","sourcesContent":["let self;\ncc.Class({\n    extends: cc.ViewGroup,\n\n    properties: {\n        scrollView              : cc.ScrollView,\n        parentListView          : cc.ScrollView,\n        cancelInnerEvents: {\n            default: true,\n            animatable: false,\n        }\n    },\n\n    onLoad () {\n        self = this;\n        this.direction = null;\n        this.start_loc = null;\n        this.node.on(cc.Node.EventType.TOUCH_START, this._onTouchBegan, this, true);\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this._onTouchMoved, this, true);\n        this.node.on(cc.Node.EventType.TOUCH_END, this._onTouchEnded, this, true);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this._onTouchCancelled, this, true);\n        this.scrollView.stopAutoScroll();\n\n    },\n    update() {\n        if (this.parentListView.getContentPosition().y < 500) {\n            if (this.scrollView.vertical) {\n                this.scrollView.vertical        = false;\n                this.parentListView.vertical    = true;\n            }\n        }else{\n            if (!this.scrollView.vertical) {\n                this.scrollView.vertical        = true;\n                this.parentListView.vertical    = false;\n            }else {\n                if (this.scrollView.getContentPosition().y < 5){\n                    if (this.scrollView.vertical) {\n                        this.scrollView.vertical        = false;\n                        this.parentListView.vertical    = true;\n                    }\n                }\n            }\n        }\n    },\n    //this is for nested scrollview\n    _hasNestedViewGroup (event, captureListeners) {\n        if (event.eventPhase !== cc.Event.CAPTURING_PHASE) return;\n        if (captureListeners) {\n            //captureListeners are arranged from child to parent\n            for (var i = 0; i < captureListeners.length; ++i) {\n                var item = captureListeners[i];\n\n                if (this.node === item) {\n                    if (event.target.getComponent(cc.ViewGroup)) {\n                        return true;\n                    }\n                    return false;\n                }\n                if (item.getComponent(cc.ViewGroup)) {\n                    return true;\n                }\n            }\n        }\n        return false;\n    },\n\n    //This is for Scrollview as children of a Button\n    _stopPropagationIfTargetIsMe (event) {\n        if (event.eventPhase === cc.Event.AT_TARGET && event.target === this.node) {\n            event.stopPropagation();\n        }\n    },\n\n    // touch event handler\n    _onTouchBegan (event, captureListeners) {\n        if (!this.enabledInHierarchy)\n            return;\n        if (this._hasNestedViewGroup(event, captureListeners)) return;\n\n        var touch = event.touch;\n        this.start_loc = event.touch.getLocation();\n        if (this.node) {\n            if (this.parentListView) {\n                this.parentListView._handlePressLogic(touch);\n            }\n\n            if (this.scrollView) {\n                this.scrollView._handlePressLogic(touch);\n            }\n        }\n\n        this._touchMoved = false;\n        this._stopPropagationIfTargetIsMe(event);\n    },\n\n    _onTouchMoved (event, captureListeners) {\n        let now_pos = event.touch.getLocation();\n        let delta_x = Math.abs(this.start_loc.x - now_pos.x);\n        let delta_y = Math.abs(this.start_loc.y - now_pos.y);\n        if ((delta_x > 5 || delta_y > 5) && !this.direction) {\n            this.direction = delta_x < delta_y ? \"parent_scrollview_move\" : \"scrollview_move\";\n        }\n        if (!this.enabledInHierarchy) return;\n        if (this._hasNestedViewGroup(event, captureListeners)) return;\n\n        var touch = event.touch;\n        if (this.node) {\n            this._handleMoveLogic(touch);\n        }\n\n        // Do not prevent touch events in inner nodes\n        if (!this.cancelInnerEvents) {\n            return;\n        }\n\n        var deltaMove =  touch.getLocation().sub(touch.getStartLocation());\n\n        //FIXME: touch move delta should be calculated by DPI.\n        if (deltaMove.mag() > 7) {\n            if (!this._touchMoved && event.target !== this.node) {\n                // Simulate touch cancel for target node\n                let cancelEvent = new cc.Event.EventTouch(event.getTouches(), event.bubbles);\n                cancelEvent.type = cc.Node.EventType.TOUCH_CANCEL;\n                cancelEvent.touch = event.touch;\n                cancelEvent.simulate = true;\n                event.target.dispatchEvent(cancelEvent);\n                this._touchMoved = true;\n            }\n        }\n\n        this._stopPropagationIfTargetIsMe(event);\n    },\n\n    _onTouchEnded (event, captureListeners) {\n        this.direction = null;\n        if (!this.enabledInHierarchy) return;\n        if (this._hasNestedViewGroup(event, captureListeners)) return;\n\n        var touch = event.touch;\n        if (this.node) {\n            this._handleReleaseLogic(touch);\n        }\n\n        if (this.parentListView) {\n            this.parentListView._dispatchEvent('touch-up');\n        }\n\n        if (this.scrollView) {\n            this.scrollView._dispatchEvent('touch-up');\n        }\n\n        if (this._touchMoved) {\n            event.stopPropagation();\n        } else {\n            this._stopPropagationIfTargetIsMe(event);\n        }\n    },\n\n    _onTouchCancelled (event, captureListeners) {\n        this.direction = null;\n        if (!this.enabledInHierarchy) return;\n        if (this._hasNestedViewGroup(event, captureListeners)) return;\n\n        // Filte touch cancel event send from self\n        if (!event.simulate) {\n            var touch = event.touch;\n            if (this.node) {\n                this._handleReleaseLogic(touch);\n            }\n        }\n\n        this._stopPropagationIfTargetIsMe(event);\n    },\n\n    _clampDelta (delta) {\n        let x = Math.abs(delta.x);\n        let y = Math.abs(delta.y);\n        if (x < y) {\n            delta.x = 0;\n        } else {\n            delta.y = 0;\n        }\n\n        return delta;\n    },\n\n    _handleMoveLogic (touch) {\n        let deltaMove = this._clampDelta(touch.getDelta());\n        if (this.direction === \"parent_scrollview_move\") {\n            if (this.parentListView) {\n                this.parentListView._processDeltaMove(deltaMove);\n            }\n        } else {\n            if (this.scrollView) {\n                this.scrollView._processDeltaMove(deltaMove);\n            }\n            if (this.parentListView) {\n                this.parentListView._processDeltaMove(deltaMove);\n            }\n        }\n    },\n\n    _handleReleaseLogic (touch) {\n        var delta = touch.getDelta();\n        delta = this._clampDelta(delta);\n        if (this.parentListView) {\n            this.parentListView._gatherTouchMove(delta);\n            this.parentListView._processInertiaScroll();\n        }\n        if (this.scrollView) {\n            this.scrollView._gatherTouchMove(delta);\n            this.scrollView._processInertiaScroll();\n        }\n    },\n});\n"]}